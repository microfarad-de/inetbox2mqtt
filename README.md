# inetbox2mqtt on Venus OS

## Introduction

This is a fork of the original inetbox2mqtt Truma iNet Box emulator found at [https://github.com/mc0110/inetbox2mqtt](https://github.com/mc0110/inetbox2mqtt), created for the purpose of porting it to standard CPython.

The original inetbox2mqtt was implemented in MicroPython and is intended to run on a dedicated microcontroller board such as an ESP32. Since some RV installations already run Victron Cerbo GX with Venus OS on a standard Raspberry Pi, it is beneficial to use the same platform to run inetbox2mqtt.

This fork ports inetbox2mqtt from MicroPython to standard CPython for execution on a Raspberry Pi. The Web OS is no longer required, as the configuration file (`etc/inetbox2mqtt`) can now be edited directly via SSH. The encrypted configuration previously generated by the Web OS has been replaced with a plain-text configuration file.

Since Venus OS manages its own network connectivity, all network configuration code has been removed from `connect.py`.

The status LED functionality previously used for LIN bus debugging has also been disabled, as users can now access the log files directly.

Additionally, a Node-Red dashboard for controlling the Truma Combi heater is included under `node-red/caravan-dashboard.json`.

## Prerequisites

This setup has been tested on a Raspberry Pi 3 running the Victron Venus OS Large version with Node-Red enabled. This guide assumes you have a working Venus OS installation and are familiar with Victron Cerbo GX, Venus OS, and Node-Red concepts.

It also assumes you have configured SSH root access to Venus OS.

For general Venus OS Large and Node-Red setup instructions, visit [https://www.victronenergy.com/live/venus-os:large](https://www.victronenergy.com/live/venus-os:large).

## Hardware Setup

This setup uses a TJA1020 TTL UART to LIN bus converter. To simplify wiring and avoid interfering with Venus OS operations, the onboard serial port of the Raspberry Pi is not used. Instead, an FT232RL-compatible USB-to-serial converter is recommended. The voltage jumper on the FT232RL board should be set to 3.3V to ensure compatibility with the TJA1020 module.

The electrical connections are described in the following table:

| FT232RL Pin | TJA1020 Pin | LIN Bus | Power Supply     |
|-------------|-------------|---------|------------------|
| GND         | GND         | GND     |                  |
| RX          | TX          |         |                  |
| TX          | RX          |         |                  |
|             | LIN         | LIN     |                  |
|             | 12V         |         | +12V fused 1A    |

Further details are provided in the [original inetbox2mqtt electrics guide](doc/ELECTRIC.md) and [this similar project](https://github.com/danielfett/inetbox.py).

## Installation

Follow these steps for installation:

1. Clone this repository to `/opt/inetbox2mqtt`.

2. Create symbolic links for the configuration and init.d startup scripts:

    ```bash
    ln -s /opt/inetbox2mqtt/etc/inetbox2mqtt /etc/inetbox2mqtt
    ln -s /opt/inetbox2mqtt/etc/init.d/inetbox2mqtt /etc/init.d/inetbox2mqtt
    ```

3. Enable auto-start for the service:

    ```bash
    ln -s /etc/init.d/inetbox2mqtt /etc/rc5.d/S99inetbox2mqtt
    ```

4. Edit the configuration parameters in `/etc/inetbox2mqtt`:
    - Use `localhost` and port `1883` for connecting to the local MQTT server provided by Venus OS.
    - Set the serial device path to your FTDI-compatible adapter, e.g.:
      `/dev/serial/by-id/usb-FTDI_FT232R_USB_UART_00000000-if00-port0`

## Venus OS Configuration

Before starting the inetbox2mqtt service, configure the following in Venus OS:

1. Enable MQTT access via the Venus GUI under **Settings > Services**.

2. Enable Node-Red under **Settings > Venus OS Large features**. This will provide the web interface to control your Truma Combi.

3. Prevent Venus OS from automatically using the serial port by adding the following line to `/etc/udev/rules.d/serial-starter.rules`:

    ```text
    ACTION=="add", ENV{ID_BUS}=="usb", ENV{ID_MODEL}=="FT232R_USB_UART", ENV{VE_SERVICE}="ignore"
    ```

    Retrieve the correct `ID_MODEL` value by running:

    ```bash
    udevadm info /dev/serial/by-id/usb-FTDI_FT232R_USB_UART_00000000-if00-port0
    ```

    Replace the device name with the appropriate identifier for your USB-to-serial converter.

    Also, comment out any other lines in that file referring to the same serial device `ID_MODEL`.

## Installing the Node-Red Dashboard

Once Node-Red is activated, follow these steps to install the dashboard:

1. Log in to the Node-Red editor at `http://<ip_address>:1881`, replacing `<ip_address>` with your Raspberry Pi's IP address.

2. Click the **hamburger menu** (top right) and select **Manage Palette**. Then find and install the `node-red-dashboard` addon.

3. Use the **Import** menu option to import the `node-red/caravan-dashboard.json` file.

    The Truma Combi dashboard will appear under the **Climate Control** tab. You may disable any additional tabs that are not relevant to your setup.

The following picture shows a screenshot of the Truma Combi control dashboard, closely resembling the original Truma iNet System app:

![Node-Red dashboard](doc/node-red.png)

> **Tip:** On iOS devices, create a home screen shortcut for the dashboard URL. Opening it this way gives it a more native app appearance, hiding the Safari address bar and navigation buttons.

## Bring-Up

Once the hardware is connected, you will need to pair the Truma CP Plus control panel with the new setup.

1. Disconnect any existing iNet Box, and navigate to **RESET > PR SET** on your CP Plus to initialize it without the iNet Box.

2. Go to the **INDEX** menu to confirm that the following two entries appear:

    - `TRUMA: Hx.00.nn`
    - `CPplus: Cy.0z.00`

3. Start the inetbox2mqtt service:

    ```bash
    /etc/init.d/inetbox2mqtt start
    ```

4. Connect the LIN bus cable to the inetbox2mqtt setup and repeat the initialization process. You should now see three entries in the **INDEX** menu:

    - `TRUMA: Hx.00.nn`
    - `CPplus: Cy.0z.00`
    - `inetbox: T23.70.0`

5. Check `/var/log/inetbox2mqtt` for output like this:

    ```text
    2025-04-29 20:57:30,833 [connect] INFO: Detected cpython 3.8.18.final.0 on port: linux
    2025-04-29 20:57:30,840 [connect] INFO: MQTT Port is switched to port: 1883
    2025-04-29 20:57:30,841 [__main__] INFO: HW-Check RPi linux
    2025-04-29 20:57:30,847 [__main__] INFO: prefix: 'truma' set: 'service/truma/set/' status: 'service/truma/control_status/'
    2025-04-29 20:57:31,852 [__main__] INFO: lin-loop is running
    2025-04-29 20:57:50,879 [mqtt_async2] INFO: Connecting to ('::1', 1883, 0, 0) id=b'b827ebd304b1' clean=1
    2025-04-29 20:57:50,907 [mqtt_async2] INFO: Connecting to ('::1', 1883, 0, 0) id=b'b827ebd304b1' clean=0
    2025-04-29 20:57:50,949 [connect] INFO: MQTT connected
    ```

6. Access the Node-Red dashboard at `http://<ip_address>:1881/ui`. It should display:

    - Current Truma Combi settings
    - Room and water temperature values
    - `"ON"` in the **Connection status** field

The dashboard can also be accessed remotely via the Victron VRM portal under the **Venus OS Large** section.
